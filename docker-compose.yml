services:
  autodroid_api_postgres_prod:
    container_name: autodroid_api_postgres_prod
    image: postgres:14
    environment:
      - POSTGRES_PASSWORD=docker
      - POSTGRES_DB=autodroid
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - ./.runtime/database/postgres:/var/lib/postgresql/data
    restart: always
    networks:
      - autodroid_api_network_prod

  autodroid_api_redis_prod:
    container_name: autodroid_api_redis_prod
    image: redis:alpine
    volumes:
      - ./.runtime/database/redis:/data
    restart: always
    networks:
      - autodroid_api_network_prod

  autodroid_api_mongo_prod:
    container_name: autodroid_api_mongo_prod
    image: mongo:6
    volumes:
      - ./.runtime/database/mongo:/data/db
    restart: always
    networks:
      - autodroid_api_network_prod

  autodroid_api_gateway_prod:
    container_name: autodroid_api_gateway_prod
    image: luizfelipelaviola/autodroid-api:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      # General
      - APP_URL=http://localhost:3333
      - APP_PORT=3333
      - NODE_ENV=development
      - DEFAULT_LANGUAGE=en
      - TZ=UTC
      - DEBUG=false

      # Cors
      - CORS_ALLOWED_FROM=http://localhost:3000,*

      # Database
      - DATABASE_URL=postgresql://postgres:docker@autodroid_api_postgres_prod:5432/autodroid?schema=public
      - DATABASE_LOGGER_ENABLED=false

      # Non-relational database
      - NON_RELATIONAL_DATABASE_URL=mongodb://autodroid_api_mongo_prod:27017/autodroid
      - NON_RELATIONAL_DATABASE_LOGGER_ENABLED=false

      # Redis
      - REDIS_HOST=autodroid_api_redis_prod
      - REDIS_PORT=6379
      - REDIS_USER=
      - REDIS_PASS=
      - REDIS_DB=1

      # Providers
      - FIREBASE_AUTHENTICATION_PROVIDER_PROJECT_ID=autodroid-dev
      - FIREBASE_AUTHENTICATION_PROVIDER_CLIENT_EMAIL=firebase-adminsdk-qe6k1@autodroid-dev.iam.gserviceaccount.com
      - FIREBASE_AUTHENTICATION_PROVIDER_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDQ2K0zPkmB4rVw\nAOCbCpypWiddld+k14NlO8UIfEbvvHboWKoazgDDBPdgsvhnqSkge9UfY3ltalID\nPw/dvTclnlTMmlHNnp9F5giOGK/K8Oo34nZjNff4GMavp00FHO0OGoKuZhEY32ul\n12NCXVtNWyArxzWQ0kpKQbYEyfEXwzgCziDU7V4zc+xu3ZttJ4F0FCIykVUDmxU7\nB+7KzFhm7UDKUUBGRWqr9miVDbXpkTgO98I2h/SqauElpcuDDO1Cx4Dh+GwRCQ8z\nVaT/uK7BBhsscmgTVtGJBJ2ScKSMyKBzh4ARi/4Ef5Br1TW+rlsnph+IbcmKyYEY\n7waeq15tAgMBAAECggEACyrzBBD6HExzuFQLrq7AFtw/y6TWizmNCK5MCHqgznQN\nBbqsCffnGYab9dtMJjro/JgymtWWai/rx8mo/wn9t3DChxhfdHfde37kCTkvuVHt\nrGRbQU3i/yzP/xeaqkHUOVNYlpvVoTddScZ9Q9C7L6VGUKD7780W9OaTpajo0ATj\nJ+NAalYO1NdXhszr1iGDYTd3kYCKulNtL5s4HFHx/4qsyrFbAJqL6ywWoswllI3c\n7ke4Z/VTzxKCs6wozJe2dSQQgZElfMKwoXiWmvbfUhAO8Kn1Bd6ss1Ps7EbRtLVJ\n50gmcHP2Dxxs8kiOmd0uxknOY5kZAWh/FGjQPhY9UQKBgQDzwNhr9qxXNSRPBKWo\n4egnA1eiTi1K/HHhClRIOu7VsjiSPahz3aQ0Qg4gn7QCQ8ID+4fArEzpK53BSXel\n8kKxtAAVbTlztrpHcGhBoEnBXXu8vmhFkY3myQ/eFS1FmshVWGDGgrRKeiv89xn+\nif52xoNyRcpKQFg6AUTRFS446QKBgQDbVtvJ3QOeEOOogglLskQ/LSQGj2PprUyr\nEzJpRWNGxSppkHvSlZZ5BLKRTtCPsWRMIpWKIOCEi3OxSYIVAGhqnKgbh+kBfZ0r\ndiMJe3L/SmJNIzVducyHHGPpALvLF58qqsxPhRkK8ChmXpjkHlA5cnExAtTVj6f+\nA4w2IPUG5QKBgQDB2eREOHDnCgROM0vr+309SZMwKSwsLogCiMxuhS/cE1iaNR76\nxpIIXWAO4fOuuWRa9ncH6/9ekKltRpg5CWmxGY3XfH3sYK3UkrjXODpv5YC6olMa\nwJ8xo0VTQVQ3vtkDxr1wIhJwCKljDMFHhUcx/r4a6xXt5y5DMy8feNDBwQKBgHzw\nfiP/bDcWocdzwv3GXs+p0/KUrTIHkDuGpNmIN+OxHdaiAZZTtTHcNidFQNIJFvuz\nW4Eh9yIpGU6sc5eo8tF/yNZd1aEOv39pPM4C7t9yrIoJ+zUXR+TSjCrGSzKFkxnH\nzrehNkGfyTN+wRJ4HfSLNuTXGwtHWEb+GFkg7tHtAoGAWvOnSxum4F89gKMky62V\nEoqFNrNvgXl15CM6LzqXo677oDCn8+GQH3jgQVmrSSNXtFLeg4OOui8Yd1jEYYUg\n01BuJ85omAnQTYTrD+76+DP5v7Abx9n9XDh4QOwgjTmFTumRC1JcSoiVy7vYp1m5\nQlAOj4vTAsS4FN3Vl+3cNMk=\n-----END PRIVATE KEY-----\n

      - GOOGLE_STORAGE_PROVIDER_PROJECT_ID=autodroid-dev
      - GOOGLE_STORAGE_PROVIDER_CLIENT_EMAIL=firebase-adminsdk-qe6k1@autodroid-dev.iam.gserviceaccount.com
      - GOOGLE_STORAGE_PROVIDER_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDQ2K0zPkmB4rVw\nAOCbCpypWiddld+k14NlO8UIfEbvvHboWKoazgDDBPdgsvhnqSkge9UfY3ltalID\nPw/dvTclnlTMmlHNnp9F5giOGK/K8Oo34nZjNff4GMavp00FHO0OGoKuZhEY32ul\n12NCXVtNWyArxzWQ0kpKQbYEyfEXwzgCziDU7V4zc+xu3ZttJ4F0FCIykVUDmxU7\nB+7KzFhm7UDKUUBGRWqr9miVDbXpkTgO98I2h/SqauElpcuDDO1Cx4Dh+GwRCQ8z\nVaT/uK7BBhsscmgTVtGJBJ2ScKSMyKBzh4ARi/4Ef5Br1TW+rlsnph+IbcmKyYEY\n7waeq15tAgMBAAECggEACyrzBBD6HExzuFQLrq7AFtw/y6TWizmNCK5MCHqgznQN\nBbqsCffnGYab9dtMJjro/JgymtWWai/rx8mo/wn9t3DChxhfdHfde37kCTkvuVHt\nrGRbQU3i/yzP/xeaqkHUOVNYlpvVoTddScZ9Q9C7L6VGUKD7780W9OaTpajo0ATj\nJ+NAalYO1NdXhszr1iGDYTd3kYCKulNtL5s4HFHx/4qsyrFbAJqL6ywWoswllI3c\n7ke4Z/VTzxKCs6wozJe2dSQQgZElfMKwoXiWmvbfUhAO8Kn1Bd6ss1Ps7EbRtLVJ\n50gmcHP2Dxxs8kiOmd0uxknOY5kZAWh/FGjQPhY9UQKBgQDzwNhr9qxXNSRPBKWo\n4egnA1eiTi1K/HHhClRIOu7VsjiSPahz3aQ0Qg4gn7QCQ8ID+4fArEzpK53BSXel\n8kKxtAAVbTlztrpHcGhBoEnBXXu8vmhFkY3myQ/eFS1FmshVWGDGgrRKeiv89xn+\nif52xoNyRcpKQFg6AUTRFS446QKBgQDbVtvJ3QOeEOOogglLskQ/LSQGj2PprUyr\nEzJpRWNGxSppkHvSlZZ5BLKRTtCPsWRMIpWKIOCEi3OxSYIVAGhqnKgbh+kBfZ0r\ndiMJe3L/SmJNIzVducyHHGPpALvLF58qqsxPhRkK8ChmXpjkHlA5cnExAtTVj6f+\nA4w2IPUG5QKBgQDB2eREOHDnCgROM0vr+309SZMwKSwsLogCiMxuhS/cE1iaNR76\nxpIIXWAO4fOuuWRa9ncH6/9ekKltRpg5CWmxGY3XfH3sYK3UkrjXODpv5YC6olMa\nwJ8xo0VTQVQ3vtkDxr1wIhJwCKljDMFHhUcx/r4a6xXt5y5DMy8feNDBwQKBgHzw\nfiP/bDcWocdzwv3GXs+p0/KUrTIHkDuGpNmIN+OxHdaiAZZTtTHcNidFQNIJFvuz\nW4Eh9yIpGU6sc5eo8tF/yNZd1aEOv39pPM4C7t9yrIoJ+zUXR+TSjCrGSzKFkxnH\nzrehNkGfyTN+wRJ4HfSLNuTXGwtHWEb+GFkg7tHtAoGAWvOnSxum4F89gKMky62V\nEoqFNrNvgXl15CM6LzqXo677oDCn8+GQH3jgQVmrSSNXtFLeg4OOui8Yd1jEYYUg\n01BuJ85omAnQTYTrD+76+DP5v7Abx9n9XDh4QOwgjTmFTumRC1JcSoiVy7vYp1m5\nQlAOj4vTAsS4FN3Vl+3cNMk=\n-----END PRIVATE KEY-----\n
      - GOOGLE_STORAGE_PROVIDER_BUCKET_NAME=autodroid-dev.appspot.com

      # Feature
      - SENTRY_DSN=

      - ADMIN_EMAILS=email-1@email.any,email-2@email.any,email-3@email.any

      - JOBS_ENABLED=true

      - STORAGE_PROVIDER_PUBLIC_READ_URL_EXPIRATION=1h
      - STORAGE_PROVIDER_PUBLIC_WRITE_URL_EXPIRATION=5m

      - WORKER_REFRESH_TOKEN_SECRET=your-refresh-secret-key
      - WORKER_REFRESH_TOKEN_EXPIRATION=30d
      - WORKER_ACCESS_TOKEN_SECRET=your-access-secret-key
      - WORKER_ACCESS_TOKEN_EXPIRATION=1h

      - PROCESSING_DEFAULT_KEEP_UNTIL=30d
      - PROCESSING_ALLOWED_KEEP_UNTIL_EXTEND=30d
    ports:
      - 3333:3333
    command: ./wait-for.sh autodroid_api_postgres_prod:5432 -q -- ./wait-for.sh autodroid_api_mongo_prod:27017 -q -- ./wait-for.sh autodroid_api_redis_prod:6379 -q -- sh -c "yarn run-s prisma:generate prisma:prod start:prod"
    depends_on:
      - autodroid_api_postgres_prod
      - autodroid_api_mongo_prod
      - autodroid_api_redis_prod
    healthcheck:
      test: curl -f http://autodroid_api_gateway_prod:3333/health/ready || exit 1
      interval: 1m
      timeout: 20s
      retries: 3
      start_period: 1m
    restart: always
    networks:
      - autodroid_api_network_prod

networks:
  autodroid_api_network_prod:
